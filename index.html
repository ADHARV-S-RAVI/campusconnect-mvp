<script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        signInWithCustomToken,
        signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        addDoc,
        collection,
        query,
        where,
        onSnapshot,
        serverTimestamp,
        getDocs
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Firebase Configuration & Initialization ---
    // IMPORTANT: These variables are provided by the Canvas environment.
    // DO NOT hardcode your Firebase config here.
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    let auth;
    let db;
    let currentUserData = null; // Stores user profile data from Firestore

    // Initialize Firebase
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        console.log("Firebase initialized successfully.");
    } catch (error) {
        console.error("Error initializing Firebase:", error);
        showMessage("Error initializing Firebase. Check console for details.", "error");
    }

    // --- Global UI Elements ---
    const landingPage = document.getElementById('landing-page');
    const authPage = document.getElementById('auth-page');
    const onboardingPage = document.getElementById('onboarding-page');
    const dashboardPage = document.getElementById('dashboard-page');
    const logoutButton = document.getElementById('logout-button');
    const homeLink = document.getElementById('home-link');
    const messageBox = document.getElementById('message-box');
    const messageContent = document.getElementById('message-content');
    const messageCloseButton = document.getElementById('message-close-button');

    // --- Message Box Functions ---
    function showMessage(message, type = "info") {
        messageContent.textContent = message;
        messageBox.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-xl z-50 transition-all duration-300 ease-in-out transform translate-y-0`;
        if (type === "error") {
            messageBox.classList.add('bg-red-600', 'text-white');
        } else if (type === "success") {
            messageBox.classList.add('bg-green-600', 'text-white');
        } else {
            messageBox.classList.add('bg-gray-800', 'text-white');
        }
        messageBox.classList.remove('hidden');
        setTimeout(() => {
            hideMessage();
        }, 5000); // Hide after 5 seconds
    }

    function hideMessage() {
        messageBox.classList.add('hidden');
    }

    messageCloseButton.addEventListener('click', hideMessage);

    // --- Page Navigation Logic ---
    function showPage(pageId) {
        document.querySelectorAll('.page-section').forEach(section => {
            section.classList.remove('active');
        });
        document.getElementById(pageId).classList.add('active');
        window.scrollTo(0, 0); // Scroll to top on page change
    }

    // --- Authentication Logic ---
    const googleSignInButton = document.getElementById('google-signin-button');
    const emailAuthForm = document.getElementById('email-auth-form');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const signupButton = document.getElementById('signup-button');
    const loginButton = document.getElementById('login-button');
    const authMessage = document.getElementById('auth-message');

    // Google Sign-in
    googleSignInButton.addEventListener('click', async () => {
        try {
            const provider = new GoogleAuthProvider();
            await signInWithPopup(auth, provider);
            // onAuthStateChanged listener will handle redirection
        } catch (error) {
            console.error("Google Sign-in Error:", error);
            authMessage.textContent = `Error: ${error.message}`;
            showMessage(`Google Sign-in failed: ${error.message}`, "error");
        }
    });

    // Email/Password Sign Up
    signupButton.addEventListener('click', async (e) => {
        e.preventDefault();
        const email = emailInput.value;
        const password = passwordInput.value;
        if (!email || !password) {
            authMessage.textContent = "Please enter email and password.";
            return;
        }
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            authMessage.textContent = "Signed up successfully! Redirecting...";
            showMessage("Signed up successfully! Welcome.", "success");
            // onAuthStateChanged listener will handle redirection
        } catch (error) {
            console.error("Email Sign-up Error:", error);
            authMessage.textContent = `Error: ${error.message}`;
            showMessage(`Sign up failed: ${error.message}`, "error");
        }
    });

    // Email/Password Log In
    loginButton.addEventListener('click', async (e) => {
        e.preventDefault();
        const email = emailInput.value;
        const password = passwordInput.value;
        if (!email || !password) {
            authMessage.textContent = "Please enter email and password.";
            return;
        }
        try {
            await signInWithEmailAndPassword(auth, email, password);
            authMessage.textContent = "Logged in successfully! Redirecting...";
            showMessage("Logged in successfully! Welcome back.", "success");
            // onAuthStateChanged listener will handle redirection
        } catch (error) {
            console.error("Email Login Error:", error);
            authMessage.textContent = `Error: ${error.message}`;
            showMessage(`Login failed: ${error.message}`, "error");
        }
    });

    // Logout
    logoutButton.addEventListener('click', async () => {
        try {
            await signOut(auth);
            showMessage("Logged out successfully.", "info");
            // onAuthStateChanged listener will handle redirection
        } catch (error) {
            console.error("Logout Error:", error);
            showMessage(`Logout failed: ${error.message}`, "error");
        }
    });

    // --- Firebase Auth State Listener ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // User is signed in
            logoutButton.classList.remove('hidden');
            const userDocRef = doc(db, "users", user.uid); // Corrected path
            try {
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    // User profile exists, go to dashboard
                    currentUserData = userDocSnap.data();
                    console.log("User data loaded:", currentUserData);
                    renderDashboard(currentUserData);
                    showPage('dashboard-page');
                } else {
                    // User profile does not exist, go to onboarding
                    showPage('onboarding-page');
                }
            } catch (error) {
                console.error("Error fetching user document:", error);
                showMessage(`Error loading profile: ${error.message}`, "error");
                // Optionally, force logout or show a critical error page
            }
        } else {
            // User is signed out
            logoutButton.classList.add('hidden');
            currentUserData = null;
            showPage('landing-page');
        }
    });

    // Initial sign-in with custom token if available (for Canvas environment)
    if (initialAuthToken) {
        signInWithCustomToken(auth, initialAuthToken).catch((error) => {
            console.error("Error signing in with custom token:", error);
            // Fallback to anonymous or public view if custom token fails
            signInAnonymously(auth).catch((anonError) => {
                console.error("Error signing in anonymously:", anonError);
            });
        });
    } else {
        // If no custom token, sign in anonymously to allow Firestore access based on rules
        // This is important for public data access if your rules allow it for unauthenticated users
        // For this MVP, we assume authenticated users for most features.
        signInAnonymously(auth).catch((anonError) => {
            console.error("Error signing in anonymously:", anonError);
        });
    }


    // --- Onboarding Logic ---
    const onboardingForm = document.getElementById('onboarding-form');

    onboardingForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const user = auth.currentUser;
        if (!user) {
            showMessage("You must be logged in to complete your profile.", "error");
            return;
        }

        const fullName = document.getElementById('fullName').value;
        const collegeName = document.getElementById('collegeName').value;
        const yearSemester = document.getElementById('yearSemester').value;
        const branch = document.getElementById('branch').value;
        const mobileNumber = document.getElementById('mobileNumber').value;

        if (!fullName || !collegeName) {
            showMessage("Please fill in all required fields (Full Name, College).", "error");
            return;
        }

        const userProfile = {
            fullName,
            college: collegeName,
            yearSemester,
            branch,
            mobile: mobileNumber,
            createdAt: serverTimestamp(),
            userId: user.uid // Store the Firebase UID
        };

        try {
            const userDocRef = doc(db, "users", user.uid); // Corrected path
            await setDoc(userDocRef, userProfile, { merge: true }); // Use merge to avoid overwriting existing fields
            currentUserData = userProfile; // Update local user data
            showMessage("Profile saved successfully! Redirecting to dashboard.", "success");
            renderDashboard(currentUserData);
            showPage('dashboard-page');
        } catch (error) {
            console.error("Error saving user profile:", error);
            showMessage(`Error saving profile: ${error.message}`, "error");
        }
    });

    // --- Dashboard Logic ---
    const dashboardUserName = document.getElementById('dashboard-user-name');
    const dashboardUserCollege = document.getElementById('dashboard-user-college');
    const dashboardUserRole = document.getElementById('dashboard-user-role');
    const dashboardUserId = document.getElementById('dashboard-user-id');
    const roleSelectionView = document.getElementById('role-selection-view');
    const requesterView = document.getElementById('requester-view');
    const workerView = document.getElementById('worker-view');
    const becomeRequesterButton = document.getElementById('become-requester-button');
    const becomeWorkerButton = document.getElementById('become-worker-button');
    const postTaskForm = document.getElementById('post-task-form');
    const postTaskMessage = document.getElementById('post-task-message');
    const myPostedTasks = document.getElementById('my-posted-tasks');
    const availableTasksList = document.getElementById('available-tasks-list');

    function renderDashboard(userData) {
        dashboardUserName.textContent = userData.fullName || 'Student';
        dashboardUserCollege.textContent = userData.college || 'N/A';
        dashboardUserRole.textContent = userData.role ? (userData.role === 'request' ? 'Requester' : 'Worker') : 'Not Set';
        dashboardUserId.textContent = userData.userId;

        // Show the appropriate view based on if a role is set
        if (userData.role) {
            roleSelectionView.classList.add('hidden');
            if (userData.role === 'request') {
                requesterView.classList.remove('hidden');
                workerView.classList.add('hidden');
                fetchMyPostedTasks(userData.userId);
            } else if (userData.role === 'do') {
                requesterView.classList.add('hidden');
                workerView.classList.remove('hidden');
                fetchAvailableTasks(userData.college);
            }
        } else {
            // If no role is set, show the role selection view
            roleSelectionView.classList.remove('hidden');
            requesterView.classList.add('hidden');
            workerView.classList.add('hidden');
        }
    }

    // Set role to Requester
    becomeRequesterButton.addEventListener('click', async () => {
        const user = auth.currentUser;
        if (user) {
            try {
                const userDocRef = doc(db, "users", user.uid); // Corrected path
                await setDoc(userDocRef, { role: 'request' }, { merge: true });
                currentUserData.role = 'request'; // Update local data
                showMessage("You are now a Requester!", "success");
                renderDashboard(currentUserData);
            } catch (error) {
                console.error("Error setting role to requester:", error);
                showMessage(`Error: Could not set role.`, "error");
            }
        }
    });

    // Set role to Worker
    becomeWorkerButton.addEventListener('click', async () => {
        const user = auth.currentUser;
        if (user) {
            try {
                const userDocRef = doc(db, "users", user.uid); // Corrected path
                await setDoc(userDocRef, { role: 'do' }, { merge: true });
                currentUserData.role = 'do'; // Update local data
                showMessage("You are now a Worker!", "success");
                renderDashboard(currentUserData);
            } catch (error) {
                console.error("Error setting role to worker:", error);
                showMessage(`Error: Could not set role.`, "error");
            }
        }
    });


    // Post a Task
    postTaskForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const user = auth.currentUser;
        if (!user || !currentUserData) {
            showMessage("You must be logged in and have a profile to post a task.", "error");
            return;
        }

        const taskDescription = document.getElementById('taskDescription').value;
        const taskPrice = parseFloat(document.getElementById('taskPrice').value);
        const taskFormat = document.getElementById('taskFormat').value;

        if (!taskDescription || !taskPrice || !taskFormat) {
            showMessage("Please fill in all task details.", "error");
            return;
        }

        const platformFee = 10; // ₹10 platform fee
        const workerReceives = taskPrice - platformFee;

        const taskData = {
            postedByUid: user.uid,
            college: currentUserData.college, // Associate task with poster's college
            description: taskDescription,
            price: taskPrice,
            workerReceives: workerReceives, // Amount worker will receive
            format: taskFormat,
            status: 'open', // 'open', 'accepted', 'completed', 'cancelled'
            createdAt: serverTimestamp()
        };

        try {
            await addDoc(collection(db, "tasks"), taskData); // Corrected path
            postTaskForm.reset();
            showMessage("Task posted successfully!", "success");
            // Tasks will automatically refresh due to onSnapshot in fetchMyPostedTasks
        } catch (error) {
            console.error("Error posting task:", error);
            showMessage(`Error posting task: ${error.message}`, "error");
        }
    });

    // Fetch My Posted Tasks (Requester)
    function fetchMyPostedTasks(userId) {
        const q = query(collection(db, "tasks"), where("postedByUid", "==", userId)); // Corrected path
        onSnapshot(q, (snapshot) => {
            if (snapshot.empty) {
                myPostedTasks.innerHTML = '<p class="text-center text-gray-600">No tasks posted yet.</p>';
                return;
            }
            myPostedTasks.innerHTML = ''; // Clear previous tasks
            snapshot.forEach((doc) => {
                const task = doc.data();
                const taskId = doc.id;
                const taskCard = `
                    <div class="bg-gray-50 p-6 rounded-lg shadow-sm border-l-4 border-indigo-400">
                        <h4 class="text-lg font-semibold text-gray-800">${task.description}</h4>
                        <p class="text-gray-600">Format: ${task.format}</p>
                        <p class="text-gray-600">Offer: ₹${task.price} (Worker gets ₹${task.workerReceives})</p>
                        <p class="text-gray-600">Status: <span class="font-medium text-blue-700">${task.status.toUpperCase()}</span></p>
                        <p class="text-gray-500 text-sm mt-2">Posted on: ${task.createdAt ? new Date(task.createdAt.toDate()).toLocaleDateString() : 'N/A'}</p>
                        </div>
                `;
                myPostedTasks.innerHTML += taskCard;
            });
        }, (error) => {
            console.error("Error fetching my posted tasks:", error);
            showMessage(`Error loading your tasks: ${error.message}`, "error");
        });
    }

    // Fetch Available Tasks (Worker) - College-Based Filtering
    function fetchAvailableTasks(college) {
        // Fetch tasks where status is 'open' AND college matches the worker's college
        const q = query(
            collection(db, "tasks"), // Corrected path
            where("status", "==", "open"),
            where("college", "==", college) // College-based filtering
        );

        onSnapshot(q, async (snapshot) => {
            if (snapshot.empty) {
                availableTasksList.innerHTML = '<p class="text-center text-gray-600">No open tasks available in your college.</p>';
                return;
            }
            availableTasksList.innerHTML = ''; // Clear previous tasks

            for (const docSnapshot of snapshot.docs) {
                const task = docSnapshot.data();
                const taskId = docSnapshot.id;

                // Fetch poster's name for display
                let posterName = "Unknown";
                try {
                    const posterDocRef = doc(db, "users", task.postedByUid); // Corrected path
                    const posterDocSnap = await getDoc(posterDocRef);
                    if (posterDocSnap.exists()) {
                        posterName = posterDocSnap.data().fullName || "A student";
                    }
                } catch (error) {
                    console.error("Error fetching poster name:", error);
                }

                const taskCard = `
                    <div class="bg-blue-50 p-6 rounded-lg shadow-sm border-l-4 border-purple-400">
                        <h4 class="text-lg font-semibold text-gray-800">${task.description}</h4>
                        <p class="text-gray-600">Format: ${task.format}</p>
                        <p class="text-gray-600">You earn: <span class="font-bold text-green-700">₹${task.workerReceives}</span> (Offer: ₹${task.price})</p>
                        <p class="text-gray-600">Posted by: ${posterName} from ${task.college}</p>
                        <p class="text-gray-500 text-sm mt-2">Posted on: ${task.createdAt ? new Date(task.createdAt.toDate()).toLocaleDateString() : 'N/A'}</p>
                        <button data-task-id="${taskId}" class="accept-task-button mt-4 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                            Accept Task
                        </button>
                    </div>
                `;
                availableTasksList.innerHTML += taskCard;
            }

            // Attach event listeners to newly rendered buttons
            document.querySelectorAll('.accept-task-button').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const taskId = event.target.dataset.taskId;
                    await acceptTask(taskId);
                });
            });

        }, (error) => {
            console.error("Error fetching available tasks:", error);
            showMessage(`Error loading available tasks: ${error.message}`, "error");
        });
    }

    // Accept Task Logic (Worker)
    async function acceptTask(taskId) {
        const user = auth.currentUser;
        if (!user) {
            showMessage("You must be logged in to accept a task.", "error");
            return;
        }

        const taskDocRef = doc(db, "tasks", taskId); // Corrected path
        try {
            // Check if task is still open before accepting
            const taskDocSnap = await getDoc(taskDocRef);
            if (!taskDocSnap.exists() || taskDocSnap.data().status !== 'open') {
                showMessage("This task is no longer available or has been accepted.", "error");
                return;
            }

            // Update task status and assign worker
            await setDoc(taskDocRef, {
                status: 'accepted',
                acceptedByUid: user.uid,
                acceptedAt: serverTimestamp()
            }, { merge: true }); // Use merge to only update specified fields

            showMessage("Task accepted successfully! It now appears in your accepted tasks (feature to be built).", "success");
            // Future: Add a section for "My Accepted Tasks" in worker view
        } catch (error) {
            console.error("Error accepting task:", error);
            showMessage(`Error accepting task: ${error.message}`, "error");
        }
    }

    // --- Initial Page Load & Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        // Initial page display is handled by onAuthStateChanged
        // Attach event listeners for navigation buttons
        document.getElementById('landing-cta-button').addEventListener('click', () => showPage('auth-page'));
        document.getElementById('landing-join-button').addEventListener('click', () => showPage('auth-page'));
        document.getElementById('home-link').addEventListener('click', (e) => {
            e.preventDefault();
            if (auth.currentUser) {
                // If logged in, go to dashboard
                showPage('dashboard-page');
            } else {
                // If not logged in, go to landing
                showPage('landing-page');
            }
        });
    });
</script>